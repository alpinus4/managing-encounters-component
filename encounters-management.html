<link rel="import" href="bower_components/polymer/polymer-element.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="./bower_components/moment/moment.js"></script>

<dom-module id="encounters-management">

  <template>

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style>
      :host {
        width: 100%;
        height: 100%;
        display: var(--encounters-management-display , inline-block);
        font-size: var(--encounters-management-font-size , 20pt);
        color: var(--encounters-management-font-color , rgb(24, 24, 24));
        background-color: var(--encounters-management-background-color , inherit);
        padding: var(--encounters-management-padding , 20px);
      }

      :host #content {
        width: 100%;
        height: 100%;
      }

      /*HEADER*/
      :host .header {
        font-size: var(--encounters-management-font-size-header , 36pt);
        color: var(--encounters-management-font-color-header , rgb(62, 62, 62));
        margin-left: 5%;
      }

      :host #headerPatientName {
        font-size: var(--encounters-management-font-size-header-patient-name, 25pt);
        color: var(--encounters-management-font-color-header-patient-name , rgb(62, 62, 62));
        margin-left: 2%;
        display: inline-block;
      }


      /*INDEX*/
      :host .index {
        font-size: var(--encounters-management-font-size-index , inherit);
        color: var(--encounters-management-font-color-index , inherit);
      }


      /*TYPE*/
      :host .type {
        font-size: var(--encounters-management-font-size-type , inherit);
        color: var(--encounters-management-font-color-type , inherit);
      }


      /*LOCATION*/
      :host .location {
        font-size: var(--encounters-management-font-size-location , inherit);
        color: var(--encounters-management-font-color-location , inherit);
      }


      /*DATETIME*/
      :host .datetime {
        font-size: var(--encounters-management-font-size-datetime , inherit);
        color: var(--encounters-management-font-color-datetime , inherit);
      }

      /* TABLE*/
      :host .table-striped>tbody>tr:nth-child(odd)>td,
            .table-striped>tbody>tr:nth-child(odd)>th {
        background-color: rgb(255, 243, 228);
      }

      :host .white-table {
        background-color: rgb(255, 255, 255);
        box-shadow: 3px 10px 20px -3px rgba(97, 97, 97, 0.5);
      }


      /* SEARCH BAR*/
      :host #searchBar {
        border: none;
        box-shadow: 3px 10px 20px -3px rgba(97, 97, 97, 0.5);
        border-radius: 0;
        background: rgb(255, 255, 255);
        width: 40%;
        float: left;
      }

      :host #searchBarInput{
        min-height: 70px;
        border: none;
        box-shadow: none;
        width: 90%;
        float: left;
      }

      :host #searchBtn {
        float: right;
        width: 10%;
        height: 70px;
      }

      :host .my-btn-default {
        border: none;
        border-radius: 0;
        min-height: 70px;
        max-height: 70px;
        box-shadow: 3px 10px 20px -3px rgba(97, 97, 97, 0.5);
        vertical-align: middle;
        line-height: 70px;
        background: rgb(255, 255, 255);
        margin-left: 2%;
      }

      :host .my-btn-default:active, .my-btn-default:focus, .my-btn-default:hover{
        background: rgb(255, 255, 255);
      }


      :host #filtersBtn, #refreshBtn{
        width: auto;
        margin-left: 5%;
      }

      :host #filterInputToDate, #filterInputFromDate, #filterInputEncounterType{
        width: 20%;
      }

      :host #resultsParams {
        width: 50%;
        float: left;
      }

      :host #actions, #pagination {
        margin-top: 2%;
        margin-bottom: 3%;
      }

      :host #actions {
        float: left;
        width: 70%;
      }

      :host #pagination {
        float: right;
        width: 20%;
      }

      :host #recordsCount {
        margin-left: 2%;
        color: var(--encounters-management-font-color-records-count  , rgb(62, 62, 62));
        font-size: 15pt;
      }

      :host .pageBtn {
        width: 70px;
        height: 70px;
      }

      /*not to display*/
      :host .hidden {
        display: none;
      }

      :host .transparentBtn {
        border:none;
        background-color:transparent;
      }

      /* loading spinner */

      .loading-spinner {
        border: 6px solid #f3f3f3;
        border-radius: 50%;
        border-top: 6px solid #141414;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(1080deg); }
      }


      /*MODAL From: https://www.w3schools.com/howto/tryit.asp?filename=tryhow_css_modal - BOOTSTRAP NOT WORKING*/
      .modal {
          display: none;
          position: fixed;
          z-index: 1;
          padding-top: 100px;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgb(0,0,0);
          background-color: rgba(0,0,0,0.4);
          font-size: 16pt;
      }

      .modal-content {
          background-color: #fefefe;
          margin: auto;
          padding: 20px;
          border: 1px solid #888;
          width: 80%;
      }

      .modal-content hr {
          border-width: 2px;
      }

      .modal-content button{
          font-size: 16pt;
      }


      .close-modal {
          color: #aaaaaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
      }

      .close-modal:hover,
      .close-modal:focus {
          color: #000;
          text-decoration: none;
          cursor: pointer;
      }


    /* DROPDOWN from https://www.w3schools.com/howto/tryit.asp?filename=tryhow_css_js_dropdown
    Bootstrap not working*/

    .dropdown {
      display: inline-block;
      position: relative;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 160px;
      overflow: auto;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
    }

    .dropdown-content a {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
    }

    .dropdown a:hover {background-color: #f1f1f1}

    .show {display:block;}

    .currentSortingSetting {
      transform: scale(1.2);
    }
    </style>

<div id="content">
      <!-- CREATE ENCOUNTER MODAL-->
      <div id="createEncounterModal" class="modal">

        <div class="modal-content">
          <span class="close-modal" on-click="CloseCreateModal">&times;</span>
          <h2>Create new encounter</h2>
          <hr></br>
          Location: <select class="form-control input-lg" id="createEncDataLocation">
                <template is="dom-repeat" items="[[availableLocations]]">
                  <option value="{{item.uuid}}">{{item.name}}</option>
                </template>
              </select></br>
          Encounter Date: <input type="text" class="form-control input-lg" id="createEncDataDate"></input></br>
          Encounter Type: <select class="form-control input-lg" id="createEncDataType">
                <template is="dom-repeat" items="[[availableTypes]]">
                  <option value="{{item.uuid}}">{{item.name}}</option>
                </template>
              </select></br>
          Form: <select class="form-control input-lg" id="createEncDataForm">
                <template is="dom-repeat" items="[[availableForms]]">
                  <option value="{{item.uuid}}">{{item.name}}</option>
                </template>
              </select></br>

              <button type='button' class="btn btn-default" on-click="IncreaseEncounterProvidersFormNumber">
                Add encounter provider
              </button></br>
              <div id="createEncDataProviders">
                <template is="dom-repeat" items="[[encounterProvidersFormNumber]]">
                  Encounter provider [[index]]</br>
                  Providers: <input type="text" class="form-control input-lg" id="provider[[index]]"></input>
                  Provider role:<select class="form-control input-lg" id="role[[index]]">
                        <template is="dom-repeat" items="[[availableEncounterRoles]]">
                          <option value="{{item.uuid}}">{{item.name}}</option>
                        </template>
                      </select>
                      <button type='button' class="btn btn-default" value="[[index]]" on-click="RemoveProvider_Create">
                        <img src="./images/ic_delete_black_48dp_2x.png" width="30px" height="30px">
                      </button>
                    </br></br>
                </template>
              </div>
          <button type='button' class="btn btn-default" id="createEncounerBtn" on-click="CreateEncounterBtnClicked">
            Create
          </button>
        </div>
      </div>

      <!-- EDIT ENCOUNTER MODAL-->
      <div id="editEncounterModal" class="modal">

        <div class="modal-content">
          <span class="close-modal" on-click="CloseEditModal">&times;</span>
          <h2>Edit encounter</h2>
          <hr></br>
          Location: <select class="form-control input-lg" id="editEncDataLocation">
                <template is="dom-repeat" items="[[availableLocations]]">
                  <option value="{{item.uuid}}">{{item.name}}</option>
                </template>
              </select></br>
          Encounter Date: <input type="text" class="form-control input-lg" id="editEncDataDate"></input></br>
          Encounter Type: <select class="form-control input-lg" id="editEncDataType">
                <template is="dom-repeat" items="[[availableTypes]]">
                  <option value="{{item.uuid}}">{{item.name}}</option>
                </template>
              </select></br>
          Form: <select class="form-control input-lg" id="editEncDataForm">
                <template is="dom-repeat" items="[[availableForms]]">
                  <option value="{{item.uuid}}">{{item.name}}</option>
                </template>
              </select></br>

              <button type='button' class="btn btn-default" on-click="IncreaseEncounterProvidersFormNumber">
                Add encounter provider
              </button></br>
              <div id="editEncDataProviders">
                <template is="dom-repeat" items="[[encounterProvidersFormNumber]]">
                  Encounter provider [[index]]</br>
                  Providers: <input type="text" class="form-control input-lg" id="provider_edit[[index]]"></input>
                  Provider role:<select class="form-control input-lg" id="role_edit[[index]]">
                        <template is="dom-repeat" items="[[availableEncounterRoles]]">
                          <option value="{{item.uuid}}">{{item.name}}</option>
                        </template>
                      </select>
                  <button type='button' class="btn btn-default" value="[[index]]" on-click="RemoveProvider_Edit">
                    <img src="./images/ic_delete_black_48dp_2x.png" width="30px" height="30px">
                  </button>
                    </br></br>
                </template>
              </div>

          <button type='button' class="btn btn-default" id="editEncounerBtn" on-click="EditEncounterBtnClicked">
            Save changes
          </button>
        </div>
      </div>

      <!-- FILTER MODAL-->
      <div id="filterModal" class="modal">

        <div class="modal-content">
          <span class="close-modal" on-click="CloseFilterModal">&times;</span>
          <h2>Filters</h2>
          <hr></br>
          <h3>Date range:</h3> </br>
          From: <input type="text" class="form-control input-lg" id="filterInputFromDate"></input>
          To: <input type="text" class="form-control input-lg" id="filterInputToDate"></input>
          </br>

          <h3>Encounter type:</h3></br>
              <select class="form-control input-lg" id="filterInputEncounterType">
                <option>All</option>
                <template is="dom-repeat" items="[[availableTypes]]">
                  <option>{{item.name}}</option>
                </template>
              </select></br>

          <button type='button' class="btn btn-default" id="FilterBtn" on-click="Filter">
            Filter
          </button>
        </div>
      </div>



      <div class="header">Encounters</div></br></br>
      <form id="searchForm" action="javascript:void(0);">
          <div id="searchBar">
            <input type="button" on-click="NewSearchQuery" id="changesq" name="changesq" class="hidden">
            <input type="text" class="form-control input-lg" id="searchBarInput" name="searchBarInput">
            <button type='submit' class="transparentBtn" id="searchBtn">
              <img src="./images/ic_search_black_48dp_2x.png" width="70px" height="70px">
            </button>
          </div>
      </form>
      <span class="glyphicons glyphicons-filter"></span>
      <div id="resultsParams">

          <button class="btn-default my-btn-default drp-btn" id="filtersBtn" on-click="FiltersModalShow">
            <img src="./images/ic_filter_list_black_48dp_2x.png" width="70px" height="70px"> Filters
          </button>

        <template is="dom-if" if="{{filters}}">
          <button class="btn-default my-btn-default drp-btn" id="clearFiltersBtn" on-click="ClearFilters">
            <img src="./images/ic_filter_list_black_48dp_2x.png" width="70px" height="70px"> Clear filters
          </button>
        </template>

        <button class="btn-default my-btn-default drp-btn" id="refreshBtn" on-click="RefreshAll">
          <img src="./images/ic_refresh_black_48dp_2x.png" width="50px" height="50px">
        </button>

      </div>
      <div id="actions">
        <button class="btn-default my-btn-default" on-click="OpenCreateModal">
          <img src="./images/ic_add_black_48dp_2x.png" width="30px" height="30px">  Create
        </button>
        <button class="btn-default my-btn-default" on-click="Import">
            <img src="./images/ic_file_upload_black_48dp_2x.png" width="30px" height="30px"> Import
        </button>
        <div id="headerPatientName">For {{encounters.0.patient.display}}
        <template is="dom-if" if="{{notFound}}">not found</template></div>
      </div>
      <div id="pagination">
        <span id="pageCount">1/5</span>
        <button class="btn-default pageBtn my-btn-default" on-click="PreviousPage">
            <img src="./images/ic_chevron_left_black_48dp_2x.png" width="30px" height="30px">
        </button>
        <button class="btn-default pageBtn my-btn-default" on-click="NextPage">
            <img src="./images/ic_chevron_right_black_48dp_2x.png" width="30px" height="30px">
        </button>
        <span id="recordsCount">{{encounters.length}} records</span>
      </div>
      <table class="table table-striped white-table">
        <thead id="tableHeaders">
          <tr>
            <th><img src="./images/ic_settings_black_48dp_2x.png" width="30px" height="30px"></th>
            <th>Encounter date <button class="transparentBtn asc" value="encounterDatetime" on-click="ClickedSort">
                <img src="./images/sort1.png" width="30px" height="30px">
              </button></th>

            <th>Encounter type <button class="transparentBtn asc" value="encounterType" on-click="ClickedSort">
              <img src="./images/sort1.png" width="30px" height="30px">
            </button></th>

            <th>Form <button class="transparentBtn asc" value="form" on-click="ClickedSort">
              <img src="./images/sort1.png" width="30px" height="30px">
            </button></th>

            <th>Provider <button class="transparentBtn asc" value="provider" on-click="ClickedSort">
              <img src="./images/sort1.png" width="30px" height="30px">
            </button></th>

            <th>Location <button class="transparentBtn asc" value="location" on-click="ClickedSort">
              <img src="./images/sort1.png" width="30px" height="30px">
            </button></th>
          </tr>
        </thead>
        <tbody>
          <template is="dom-repeat" items="[[encountersToDisplay]]">
            <tr>
              <td>
                <button class="btn btn-default" on-click="OpenEditModal" value="{{item.uuid}}">
                  <img src="./images/ic_edit_black_48dp_2x.png" width="20px" height="20px">
                </button>
                <button class="btn btn-danger" on-click="DeleteItem" value="{{item.uuid}}">
                  <img src="./images/ic_delete_forever_white_48dp_2x.png" width="20px" height="20px">
                </button>
              </td>
              <td class="datetime">{{item.encounterDatetime}}</td>
              <td class="type">{{item.encounterType.display}}</td>
              <td class="form">{{item.form.display}}</td>
              <td class="providers">
                <template is="dom-repeat" items="[[item.encounterProviders]]">
                {{item.provider.display}} &nbsp;
                </template>
  </td>
  <td class="location">{{item.location.display}}</td>
  </tr>
  </template>

  <template is="dom-if" if="{{notFound}}">
            <tr>
              <td colspan="7" align="center"></br>Not found any matching encounters.</td>
            </tr>
          </template>

  <template is="dom-if" if="{{loading}}">
            <tr>
            </br>
              <td colspan="7" align="center"><div class="loading-spinner"></div></td>
            </tr>
          </template>

  </tbody>
  </table>
  </div>

<!-- BASE ACTIONS-->
  <iron-ajax url="http://localhost:8080/lh-toolkit/ws/rest/v1/encounter"
  params='{{searchQueryObj}}'
  content-type="application/json"
  handle-as="json"
  with-credentials="true"
  on-response="handleResponseGetAll"
  method="GET"
  on-error="_error"
  id="iron_ajax_get_all"></iron-ajax>

    <iron-ajax url="http://localhost:8080/lh-toolkit/ws/rest/v1/encounter"
    body='{{newEncounterObj}}'
    content-type="application/json"
     handle-as="json"
     with-credentials="true"
     on-response="handleResponseCreateNew"
     method="POST"
     on-error="_error"
     id="iron_ajax_create"></iron-ajax>

    <iron-ajax url="{{deleteEditURL}}"
    with-credentials="true"
    content-type="application/json"
    method="DELETE"
    on-error="_error"
    id="iron_ajax_delete"></iron-ajax>

    <iron-ajax url="{{deleteEditURL}}"
    body='{{editEncounterObj}}'
    content-type="application/json"
    handle-as="json"
    with-credentials="true"
    on-response="handleResponseEdit"
    method="POST"
    on-error="_error"
    id="iron_ajax_edit"></iron-ajax>

<!-- TO CREATE AND EDIT -->
  <iron-ajax url="http://localhost:8080/lh-toolkit/ws/rest/v1/provider"
  params=''
  content-type="application/json"
  handle-as="json"
  with-credentials="true"
  on-response="handleResponseGetProvider"
  method="GET"
  on-error="_error"
  id="iron_ajax_get_providers"></iron-ajax>

  <iron-ajax url="http://localhost:8080/lh-toolkit/ws/rest/v1/provider"
  params=''
  content-type="application/json"
  handle-as="json"
  with-credentials="true"
  on-response="handleResponseGetProviderEdit"
  method="GET"
  on-error="_error"
  id="iron_ajax_get_providers_edit"></iron-ajax>

  <iron-ajax url="http://localhost:8080/lh-toolkit/ws/rest/v1/encountertype"
  params=''
  content-type="application/json"
  handle-as="json"
  with-credentials="true"
  on-response="handleResponseGetEncounterType"
  method="GET"
  on-error="_error"
  id="iron_ajax_get_type"></iron-ajax>

  <iron-ajax url="http://localhost:8080/lh-toolkit/ws/rest/v1/location"
  params=''
  content-type="application/json"
  handle-as="json"
  with-credentials="true"
  on-response="handleResponseGetLocation"
  method="GET"
  on-error="_error"
  id="iron_ajax_get_location"></iron-ajax>

  <iron-ajax url="http://localhost:8080/lh-toolkit/ws/rest/v1/form"
  params=''
  content-type="application/json"
  handle-as="json"
  with-credentials="true"
  on-response="handleResponseGetForm"
  method="GET"
  on-error="_error"
  id="iron_ajax_get_form"></iron-ajax>

  <iron-ajax url="http://localhost:8080/lh-toolkit/ws/rest/v1/encounterrole"
  params=''
  content-type="application/json"
  handle-as="json"
  with-credentials="true"
  on-response="handleResponseGetEncounterRole"
  method="GET"
  on-error="_error"
  id="iron_ajax_get_encounterRole"></iron-ajax>

  </template>

  <script>
    class EncountersManagement extends Polymer.Element {
      static get is() {
        return 'encounters-management';
      }
      static get properties() {
        return {
          encounters: {
            type: Array,
            notice: true
          },
          encountersToDisplay: {
            type: Array,
            notice: true
          },
          searchQuery: {
            type: String,
            observer: "_changedSearchQuery",
            notice: true
          },
          searchQueryObj: {
            type: Object
          },
          newEncounterObj: {
            type: Object,
            notice: true
          },
          editEncounterObj: {
            type: Object,
            notice: true
          },
          notFound: {
            type: Boolean
          },
          loading: {
            type: Boolean
          },
          pageNmb: {
            type: Number
          },
          numberRecordsPerPage: {
            type: Number
          },
          deleteEditURL: {
            type: String
          },
          filters: {
            type: Boolean
          },
          availableLocations: {
            type: Array
          },
          availableTypes: {
            type: Array
          },
          availableForms: {
            type: Array
          },
          availableEncounterRoles: {
            type: Array
          },
          encounterProvidersFormNumber: {
            type: Array,
            notice: true
          },
          providerCallsToDo: {
            type: Object
          },
          currentEncounterToEdit: {
            type: Object
          }
        }
      }

      constructor() {
        super();
        this.numberRecordsPerPage = 8;
      }

      ready() {
        super.ready();

        //SEARCH
        this.$.searchForm.addEventListener('submit', function(evt) {
          this.changesq.click();
        });


        ///////SEARCH FOR EDIT, CREATE, FILTER, ... (FOR <SELECT> TAGS)
        this.GetAllAvailable_GenerateRequestAjax(this.$.iron_ajax_get_location);
        this.GetAllAvailable_GenerateRequestAjax(this.$.iron_ajax_get_type);
        this.GetAllAvailable_GenerateRequestAjax(this.$.iron_ajax_get_form);
        this.GetAllAvailable_GenerateRequestAjax(this.$.iron_ajax_get_encounterRole);

        this.encounterProvidersFormNumber=[];
      }

      GetRolesFromForm(roleIDPrefix){
        var providersArray = [];
        for(var i = 0; i < this.encounterProvidersFormNumber.length ; i++){
          var EncounterRoleElement = this.shadowRoot.querySelector(roleIDPrefix+""+i);
          providersArray.push({"provider":"", "encounterRole":EncounterRoleElement.options[EncounterRoleElement.selectedIndex].value});
        }
        return providersArray;
      }

      GetRolesAndProvidersFromForm(roleIDPrefix, providerIDPrefix){
        var providersArray = [];
        for(var i = 0; i < this.encounterProvidersFormNumber.length ; i++){
          var EncounterRoleElement = this.shadowRoot.querySelector(roleIDPrefix+""+i);
          providersArray.push({"provider":this.shadowRoot.querySelector(providerIDPrefix+""+i).value, "encounterRole":EncounterRoleElement.options[EncounterRoleElement.selectedIndex].text});
        }
        return providersArray;
      }

      PutRolesAndProvidersToForm(arrayWithValues, roleIDPrefix, providerIDPrefix){
        for(var i = 0; i < this.encounterProvidersFormNumber.length ; i++){
          this.SetSelectedInSelect(arrayWithValues[i].encounterRole,this.shadowRoot.querySelector(roleIDPrefix+""+i));
          this.shadowRoot.querySelector(providerIDPrefix+""+i).value = arrayWithValues[i].provider;
        }
      }

/////////DELETE//////////////
      DeleteItem(e) {
        console.log(e.target);
        this.deleteEditURL = "http://localhost:8080/lh-toolkit/ws/rest/v1/encounter/" + e.target.value;
        this.$.iron_ajax_delete.generateRequest();
        this.RefreshAll();
      }

/////////IMPORT//////////////
      Import() {
        console.log("import");
      }

/////////SEARCH//////////////
      _changedSearchQuery() {
        this.searchQueryObj = {
          q: this.searchQuery,
          v: "full"
        }
        this.$.iron_ajax_get_all.generateRequest();
        this.loading = true;
        this.encounters = [];
        this.notFound = false;
      }

      NewSearchQuery(e) {
        this.searchQuery = this.$.searchBarInput.value;
      }

      handleResponseGetAll(data) {
        this.pageNmb = 0;
        var encounters = data.detail.response.results;

        if (encounters.length == 0) {

          this.notFound = true;
          this.encountersToDisplay = [];

        } else {
          //parse dates and correct data
          for (var i = 0; i < encounters.length; i++) {
            encounters[i].encounterDatetime = parseDate(encounters[i].encounterDatetime);
            encounters[i].encounterType.display = encounters[i].encounterType.display.toLowerCase();
            encounters[i].encounterType.display = capitalizeFirstLetter(encounters[i].encounterType.display);
            encounters[i].patient.display = encounters[i].patient.display.replace(/[^a-zA-Z]+/g, ' '); //Get only name without id

            for (var x = 0; x < encounters[i].encounterProviders.length; x++) {
              encounters[i].encounterProviders[x].provider.display =
                encounters[i].encounterProviders[x].provider.display.replace(/[^a-zA-Z]+/g, ' '); //Get only name without id
            }

          }
          this.encountersToDisplay = this.PushPage(encounters);
        }
        this.encounters = encounters;
        this.loading = false;
        this.UpdatePagination();
      }

      /////SEARCH FOR <SELECT> TAGS
          ///Location
          handleResponseGetLocation(data) {
            this.availableLocations = data.detail.response.results;
          }

          ///Type
          handleResponseGetEncounterType(data) {
            this.availableTypes = data.detail.response.results;
          }

          ///Form
          handleResponseGetForm(data) {
            this.availableForms = data.detail.response.results;
          }

          ///Role
          handleResponseGetEncounterRole(data) {
            this.availableEncounterRoles = data.detail.response.results;
          }


          GetAllAvailable_GenerateRequestAjax(ironAjax) {
              ironAjax.params = {
                v: "full"
              };
            ironAjax.generateRequest();
          }


          PutSQ_GenerateRequestAjax(ironAjax, sq) {
              ironAjax.params = {
                q: sq,
                v: "full"
              };
            ironAjax.generateRequest();
          }

/////////EDIT//////////////
      OpenEditModal(e) {
        this.encounterProvidersFormNumber=[];
        this.$.editEncounterModal.style.display = "block";
        this.deleteEditURL = "http://localhost:8080/lh-toolkit/ws/rest/v1/encounter/" + e.target.value;
        this.SetValuesToEdit(e);
      }

      SetValuesToEdit(e){
        this.currentEncounterToEdit = this.GetMatchingEncounter(e.target.value);
        this.$.editEncDataDate.value = this.currentEncounterToEdit.encounterDatetime;
        this.SetSelectedInSelect(this.currentEncounterToEdit.form.name, this.$.editEncDataForm);
        this.SetSelectedInSelect(this.currentEncounterToEdit.encounterType.name,this.$.editEncDataType);
        this.SetSelectedInSelect(this.currentEncounterToEdit.location.name,this.$.editEncDataLocation);
        var tmp = [];
        for (var i = 0; i < this.encounterProvidersFormNumber.length+this.currentEncounterToEdit.encounterProviders.length; i++) {
          tmp.push(""+i);
        }
        this.encounterProvidersFormNumber = tmp;
        SetEditProviderValues(this.shadowRoot, this.currentEncounterToEdit);
      }

      RemoveProvider_Edit(e){
        var currentProviders = this.currentEncounterToEdit.encounterProviders;
        var index = currentProviders.indexOf(currentProviders[e.target.value]);
        currentProviders.splice(index, 1);//delete
        this.encounterProvidersFormNumber.splice(-1,1);
        var e={
          target : {
            value: this.currentEncounterToEdit.uuid
          }
        }
        this.OpenEditModal(e);
      }


      CloseEditModal() {
          this.$.editEncounterModal.style.display = "none";
      }

      SetSelectedInSelect(value, element){
        for (var i = 0; i < element.options.length ; i++){
          if(element.options[i].text == value){
            element.options[i].selected = true;
          }
        }
      }

      GetMatchingEncounter(encounteruuid) {
        for (var i = 0; i < this.encountersToDisplay.length; i++) {
          if (this.encountersToDisplay[i].uuid == encounteruuid) {
            return this.encountersToDisplay[i];
          }
        }
      }

      EditEncounterBtnClicked(){
        if(this.encounterProvidersFormNumber.length !="")  {
          this.Edit_EncounterObj();
          this.providerCallsToDo={
            quantity : this.encounterProvidersFormNumber.length,
            current : 0
          };
          this.PutSQ_GenerateRequestAjax(this.$.iron_ajax_get_providers_edit,  this.shadowRoot.querySelector("#provider_edit"+this.providerCallsToDo.current).value);
        }else{
          this.Edit_EncounterObjWithoutProviders();
          this.$.iron_ajax_create.generateRequest();
        }
      }

      Edit_EncounterObj(){
        this.editEncounterObj = {
          "encounterProviders": this.GetRolesFromForm("#role_edit"),
          "form": this.$.editEncDataForm.options[this.$.editEncDataForm.selectedIndex].value,
          "patient": this.encounters[0].patient.uuid,
          "location": this.$.editEncDataLocation.options[this.$.editEncDataLocation.selectedIndex].value,
          "encounterDatetime": ""+(new Date(parseDateReturnDate(this.$.editEncDataDate.value)).toISOString()),
          "encounterType": this.$.editEncDataType.options[this.$.editEncDataType.selectedIndex].value
        };
      }

      Edit_EncounterObjWithoutProviders(){
        this.editEncounterObj = {
          "form": this.$.editEncDataForm.options[this.$.editEncDataForm.selectedIndex].value,
          "patient": this.encounters[0].patient.uuid,
          "location": this.$.editEncDataLocation.options[this.$.editEncDataLocation.selectedIndex].value,
          "encounterDatetime": ""+(new Date(parseDateReturnDate(this.$.editEncDataDate.value)).toISOString()),
          "encounterType": this.$.editEncDataType.options[this.$.editEncDataType.selectedIndex].value
        };
      }

      handleResponseGetProviderEdit(data){
        this.editEncounterObj.encounterProviders[this.providerCallsToDo.current].provider = data.detail.response.results[0].uuid;
        this.providerCallsToDo.current++;
        if(this.providerCallsToDo.current < this.providerCallsToDo.quantity){
          this.PutSQ_GenerateRequestAjax(this.$.iron_ajax_get_providers_edit, this.shadowRoot.querySelector("#provider_edit"+this.providerCallsToDo.current).value);
        }else{
          this.$.iron_ajax_edit.generateRequest();
        }
      }

      handleResponseEdit(data){
        console.log("EDITED");
        console.log(data.detail.response);
        this.RefreshAll();
        this.CloseEditModal();
      }


/////////SORT//////////////
      Sort(key, asc = true) {
        var simpleArrayToSort = [];

        for (var i = 0; i < this.encounters.length; i++) {
          var date = new Date(parseDateReturnDate(this.encounters[i].encounterDatetime));
          var ObjToPush;
          if(this.encounters[i].encounterProviders.length > 0){
            ObjToPush = {
              uuid: this.encounters[i].uuid,
              encounterDatetime: date,
              encounterType: this.encounters[i].encounterType.display,
              form: this.encounters[i].form.display,
              location: this.encounters[i].location.display,
              provider: this.encounters[i].encounterProviders[0].provider.display
            };
          }else{
            ObjToPush = {
              uuid: this.encounters[i].uuid,
              encounterDatetime: date,
              encounterType: this.encounters[i].encounterType.display,
              form: this.encounters[i].form.display,
              location: this.encounters[i].location.display,
              provider: "z"
            };
          }
          simpleArrayToSort.push(ObjToPush);
        }
        var simple_sorted = sortByKey(simpleArrayToSort, key, asc);

        var sorted_full = [];
        for (var i = 0; i < simple_sorted.length; i++) {
          for (var x = 0; x < this.encounters.length; x++) {
            if (simple_sorted[i].uuid == this.encounters[x].uuid) {
              sorted_full.push(this.encounters[x]);
            }
          }
        }

        this.encounters = sorted_full;
        this.RefreshRecords();
      }

      ClickedSort(e) {
        var sortBtns = this.$.tableHeaders.querySelectorAll(".transparentBtn");
        for (var i = 0; i < sortBtns.length; i++) {
          if (sortBtns[i].classList.contains('currentSortingSetting')) {
            sortBtns[i].classList.remove('currentSortingSetting');
          }
        }

        var isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);

        if(!isChrome) {
          e.target.classList.toggle("asc");
          if (e.target.classList.contains("asc")) {
            this.Sort(e.target.value);
            e.target.querySelector("img").src = "./images/sort1.png";
            e.target.classList.add("currentSortingSetting");
          } else {
            this.Sort(e.target.value, false);
            e.target.querySelector("img").src = "./images/sort2.png";
            e.target.classList.add("currentSortingSetting");
          }
        }else{
          e.target.parentNode.classList.toggle("asc");
          if (e.target.parentNode.classList.contains("asc")) {
            this.Sort(e.target.parentNode.value);
            e.target.src = "./images/sort1.png";
            e.target.parentNode.classList.add("currentSortingSetting");
          } else {
            this.Sort(e.target.parentNode.value, false);
            e.target.src = "./images/sort2.png";
            e.target.parentNode.classList.add("currentSortingSetting");
          }
        }
      }

/////////FILTER//////////////
      Filter() {
        this.CloseFilterModal();
        if(this.$.filterInputFromDate.value != "" || this.$.filterInputToDate.value != ""
            || this.$.filterInputEncounterType.options[this.$.filterInputEncounterType.selectedIndex].text != "All"){
          this.filters = true;
        }else{
          this.filters = false;
        }
        this.RefreshRecords();
      }

      ClearFilters(){
        this.filters = false;
        this.$.filterInputFromDate.value = "";
        this.$.filterInputToDate.value = "";
        this.$.filterInputEncounterType.selectedIndex = 0;
        this.RefreshRecords();
        this.ResetPageNmb();
      }


      FiltersModalShow() {
        this.$.filterModal.style.display = "block";
      }

      CloseFilterModal() {
        this.$.filterModal.style.display = "none";
      }

      FilterEncounter(encounter){
        var decision = true;
        var fromDate = new Date(this.$.filterInputFromDate.value);
        var toDate = new Date(this.$.filterInputToDate.value);
        var encounterDate = new Date(encounter.encounterDatetime);
        var type = this.$.filterInputEncounterType.options[this.$.filterInputEncounterType.selectedIndex].text.toLowerCase();
        var encounterType = encounter.encounterType.display.toLowerCase();

        if(fromDate != "" || toDate != "" ){
          if(encounterDate < fromDate || encounterDate > toDate){
            decision = false;
          }
        }

          if(type != encounterType){
            decision = false;
          }
        return decision;
      }

/////////CREATE NEW//////////////
      OpenCreateModal() {
        this.$.createEncounterModal.style.display = "block";
        this.encounterProvidersFormNumber=[];
      }

      CloseCreateModal() {
        this.$.createEncounterModal.style.display = "none";
      }

      RemoveProvider_Create(e){
        var currentProviders = this.GetRolesAndProvidersFromForm("#role","#provider");
        var index = currentProviders.indexOf(currentProviders[e.target.value]);
        currentProviders.splice(index, 1);//delete
        var tmp = this.encounterProvidersFormNumber;
        tmp.splice(-1,1);
        this.encounterProvidersFormNumber=[];
        this.encounterProvidersFormNumber=tmp;
        this.PutRolesAndProvidersToForm(currentProviders, "#role","#provider");
      }

      CreateEncounterBtnClicked() {
        if(this.encounterProvidersFormNumber.length !="")  {
          this.CreateEncounterObj();
          this.providerCallsToDo={
            quantity : this.encounterProvidersFormNumber.length,
            current : 0
          };
          this.PutSQ_GenerateRequestAjax(this.$.iron_ajax_get_providers,  this.shadowRoot.querySelector("#provider"+this.providerCallsToDo.current).value);
        }else{
          this.CreateEncounterObjWithoutProviders();
          this.$.iron_ajax_create.generateRequest();
        }
        this.CloseCreateModal();
      }

      handleResponseGetProvider(data) {
        this.newEncounterObj.encounterProviders[this.providerCallsToDo.current].provider = data.detail.response.results[0].uuid;
        this.providerCallsToDo.current++;
        if(this.providerCallsToDo.current < this.providerCallsToDo.quantity){
          this.PutSQ_GenerateRequestAjax(this.$.iron_ajax_get_providers, this.shadowRoot.querySelector("#provider"+this.providerCallsToDo.current).value);
        }else{
          this.$.iron_ajax_create.generateRequest();
        }
      }

      CreateEncounterObj() {
        this.newEncounterObj = {
          "encounterProviders": this.GetRolesFromForm("#role"),
          "form": this.$.createEncDataForm.options[this.$.createEncDataForm.selectedIndex].value,
          "patient": this.encounters[0].patient.uuid,
          "location": this.$.createEncDataLocation.options[this.$.createEncDataLocation.selectedIndex].value,
          "encounterDatetime": ""+(new Date(parseDateReturnDate(this.$.createEncDataDate.value)).toISOString()),
          "encounterType": this.$.createEncDataType.options[this.$.createEncDataType.selectedIndex].value
        };
      }

      CreateEncounterObjWithoutProviders(){
        this.newEncounterObj = {
          "form": this.$.createEncDataForm.options[this.$.createEncDataForm.selectedIndex].value,
          "patient": this.encounters[0].patient.uuid,
          "location": this.$.createEncDataLocation.options[this.$.createEncDataLocation.selectedIndex].value,
          "encounterDatetime": ""+(new Date(parseDateReturnDate(this.$.createEncDataDate.value)).toISOString()),
          "encounterType": this.$.createEncDataType.options[this.$.createEncDataType.selectedIndex].value
        };
      }

      handleResponseCreateNew(data) {
        console.log("NEW");
        console.log(data.detail.response);
        this.$.iron_ajax_get_all.generateRequest();
      }

      IncreaseEncounterProvidersFormNumber(e){
        var tmp = [];

        for (var i = 0; i < this.encounterProvidersFormNumber.length+1; i++) {
          tmp.push(""+i);
        }

        this.encounterProvidersFormNumber = tmp;
      }



/////////PAGINATION//////////////
      PushPage(encounters) {
        var maxIndx = (this.pageNmb + 1) * (this.numberRecordsPerPage - 1);
        if (this.pageNmb != 0) {
          var minIndx = this.pageNmb * (this.numberRecordsPerPage - 1) + 1;
        } else {
          var minIndx = 0;
        }

        //filter
        var filteredEncounters = [];
        for (var i = 0; i < encounters.length; i++) {
            if(this.filters){
              var toPush = this.FilterEncounter(encounters[i]);
              if(toPush){
                filteredEncounters.push(encounters[i]);
              }
            }else{
              filteredEncounters.push(encounters[i]);
            }
        }
        var encountersToReturn = [];

        //putToShow
        for (var i = minIndx; i < (maxIndx + 1); i++) {
          if (filteredEncounters[i]) {
            encountersToReturn.push(filteredEncounters[i]);
          }
        }
        return encountersToReturn;
      }

      RefreshRecords(){
        this.encountersToDisplay = this.PushPage(this.encounters);
      }

      RefreshAll(){
        this._changedSearchQuery();
      }

      ResetPageNmb(){
        this.pageNmb = 0;
      }

      PreviousPage() {
        this.pageNmb--;
        this.pageNmb = Math.max(0, Math.min(Math.floor(this.encounters.length / this.numberRecordsPerPage), this.pageNmb)); //clamp
        this.RefreshRecords();
        this.UpdatePagination();
      }

      NextPage() {
        this.pageNmb++;
        this.pageNmb = Math.max(0, Math.min(Math.floor(this.encounters.length / this.numberRecordsPerPage), this.pageNmb)); //clamp
        this.RefreshRecords();
        this.UpdatePagination();
      }

      UpdatePagination() {
        var pageNumber = this.pageNmb + 1;
        this.$.pageCount.innerHTML = pageNumber + "/" + (Math.floor(this.encounters.length / this.numberRecordsPerPage) + 1);
      }


/////////ERROR//////////////
      _error(event) {
        console.log("Event:");
        console.log(event);
        console.log("");
        console.log("Event Detail:");
        console.log(event.detail);
        console.log("");
        console.log("Event Detail Error");
        console.log(event.detail.error);
        console.log("");
        console.log("Error Message");
        console.log(event.detail.error.message);
        console.log("");
        console.log("Request");
        console.log(event.detail.request);
        console.log("");
        console.log("Response");
        console.log(event.detail.response);
        console.log("");
        console.log("Request Response");
        console.log(event.detail.request.response);
        console.log("");
        console.log("");
      }

    }
    customElements.define(EncountersManagement.is, EncountersManagement);
  </script>

  <script>
    function parseDate(givenDate) {
      var date = new Date(givenDate);

      //part of code from https://stackoverflow.com/questions/3605214/javascript-add-leading-zeroes-to-date with added hours and minutes
      var myDateString;
      date.setDate(date.getDate() + 0);
      myDateString = ('0' + date.getDate()).slice(-2) + '/' +
        ('0' + (date.getMonth() + 1)).slice(-2) + '/' +
        date.getFullYear() + '  ' +
        ('0' + date.getHours()).slice(-2) + ':' +
        ('0' + date.getMinutes()).slice(-2);

      return myDateString;
    }

    function parseDateReturnDate(givenDate) {
      var date = moment(givenDate, "DD/MM/YYYY HH:mm").format("MM/DD/YYYY HH:mm");
      return date;
    }

    //part of code from https://stackoverflow.com/questions/1026069/how-do-i-make-the-first-letter-of-a-string-uppercase-in-javascript
    function capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    //part of code from https://stackoverflow.com/questions/8175093/simple-function-to-sort-an-array-of-objects modified by me
    function sortByKey(array, key, asc) {
      return array.sort(function(a, b) {
        var x = a[key];
        var y = b[key];
        if (asc) {
          return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        } else {
          return ((x < y) ? 1 : ((x > y) ? -1 : 0));
        }
      });
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function SetEditProviderValues(shadowRoot, encounterToEdit) {
      await sleep(10);
      for(var x = 0 ; x < encounterToEdit.encounterProviders.length; x++){
        shadowRoot.querySelector("#provider_edit"+x).value = encounterToEdit.encounterProviders[x].provider.display;
        for (var i = 0; i < shadowRoot.querySelector("#role_edit"+x).options.length ; i++){
          if(shadowRoot.querySelector("#role_edit"+x).options[i].text == encounterToEdit.encounterProviders[x].encounterRole.display){
            shadowRoot.querySelector("#role_edit"+x).options[i].selected = true;
          }
        }
      }
    }

  </script>

</dom-module>
